{"ast":null,"code":"var _jsxFileName = \"C:\\\\HRM_Project\\\\frontend\\\\src\\\\pages\\\\user\\\\Chat.js\",\n  _s = $RefreshSig$();\nimport React, { useEffect, useRef, useState } from \"react\";\nimport io from \"socket.io-client\";\nimport api from \"../../api\";\nimport UserLayout from \"../../layouts/UserLayout\";\nimport { useAuth } from \"../../context/AuthContext\";\n\n// Socket URL\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst SOCKET_BASE = (process.env.REACT_APP_API_BASE || \"http://localhost:5000\").replace(\"/api\", \"\");\nconst socket = io(SOCKET_BASE, {\n  transports: [\"websocket\"],\n  autoConnect: true\n});\nexport default function Chat() {\n  _s();\n  const {\n    user\n  } = useAuth();\n  const me = user;\n  const [deptRoom, setDeptRoom] = useState(null);\n  const [privateRooms, setPrivateRooms] = useState([]);\n  const [employees, setEmployees] = useState([]);\n  const [chatOutsideDept, setChatOutsideDept] = useState(false);\n  const [currentRoom, setCurrentRoom] = useState(null);\n  const [messages, setMessages] = useState([]);\n  const [text, setText] = useState(\"\");\n  const bottomRef = useRef(null);\n  const joinedRoomIdRef = useRef(null);\n  const myId = me === null || me === void 0 ? void 0 : me._id;\n  const myDept = (me === null || me === void 0 ? void 0 : me.department) || null;\n  const extractId = val => {\n    var _ref, _val$_id;\n    if (!val) return \"\";\n    if (typeof val === \"string\") return val;\n    return (_ref = (_val$_id = val._id) !== null && _val$_id !== void 0 ? _val$_id : val.id) !== null && _ref !== void 0 ? _ref : \"\";\n  };\n  const isMine = m => String(extractId(m.sender)) === String(myId);\n  const normalizeMsg = raw => {\n    var _raw$sender;\n    return {\n      _id: String((raw === null || raw === void 0 ? void 0 : raw._id) || Math.random().toString(36).slice(2)),\n      roomId: String((raw === null || raw === void 0 ? void 0 : raw.roomId) || (currentRoom === null || currentRoom === void 0 ? void 0 : currentRoom._id) || \"\"),\n      sender: {\n        _id: extractId(raw === null || raw === void 0 ? void 0 : raw.sender),\n        username: (raw === null || raw === void 0 ? void 0 : (_raw$sender = raw.sender) === null || _raw$sender === void 0 ? void 0 : _raw$sender.username) || (raw === null || raw === void 0 ? void 0 : raw.fromUsername) || (raw === null || raw === void 0 ? void 0 : raw.fromUserName) || \"N/A\"\n      },\n      content: (raw === null || raw === void 0 ? void 0 : raw.content) || (raw === null || raw === void 0 ? void 0 : raw.message) || \"\",\n      createdAt: (raw === null || raw === void 0 ? void 0 : raw.createdAt) || new Date().toISOString()\n    };\n  };\n\n  // -----------------------------------------------\n  // 1) JOIN SOCKET + CLEANUP CHU·∫®N (fix destroy error)\n  // -----------------------------------------------\n  useEffect(() => {\n    if (myId) {\n      socket.emit(\"join\", {\n        userId: myId,\n        department: myDept\n      });\n    }\n    return () => {\n      if (joinedRoomIdRef.current) {\n        socket.emit(\"leave_room\", {\n          roomId: joinedRoomIdRef.current\n        });\n      }\n\n      // cleanup t·∫•t c·∫£ listener tr√°nh leak\n      socket.off(\"receive_message\");\n      socket.off(\"join_room\");\n      socket.off(\"leave_room\");\n    };\n  }, [myId, myDept]);\n\n  // -----------------------------------------------\n  // LOAD ROOMS\n  // -----------------------------------------------\n  const loadRooms = async () => {\n    try {\n      const res = await api.get(\"/messages/rooms\");\n      setPrivateRooms(res.data.privateRooms || []);\n      setDeptRoom(res.data.deptRoom || null);\n    } catch (e) {\n      console.error(\"‚ùå loadRooms\", e);\n    }\n  };\n\n  // -----------------------------------------------\n  // LOAD EMPLOYEES (fix normalize)\n  // -----------------------------------------------\n  const loadEmployees = async () => {\n    try {\n      const scope = chatOutsideDept ? \"all\" : \"dept\";\n      const res = await api.get(`/employees/peers?scope=${scope}`);\n      setEmployees((res.data || []).map(e => {\n        var _e$userId, _e$userId2;\n        return {\n          _id: e._id,\n          name: e.name,\n          userId: (_e$userId = e.userId) === null || _e$userId === void 0 ? void 0 : _e$userId._id,\n          username: (_e$userId2 = e.userId) === null || _e$userId2 === void 0 ? void 0 : _e$userId2.username,\n          department: e.department\n        };\n      }));\n    } catch (e) {\n      console.error(\"‚ùå loadEmployees\", e);\n      setEmployees([]);\n    }\n  };\n  useEffect(() => loadRooms(), []);\n  useEffect(() => loadEmployees(), [chatOutsideDept]);\n\n  // -----------------------------------------------\n  // LOAD MESSAGES BY ROOM\n  // -----------------------------------------------\n  const loadMessages = async room => {\n    try {\n      const res = await api.get(`/messages/${room._id}`);\n      setMessages(res.data.map(normalizeMsg));\n      setTimeout(() => {\n        var _bottomRef$current;\n        return (_bottomRef$current = bottomRef.current) === null || _bottomRef$current === void 0 ? void 0 : _bottomRef$current.scrollIntoView();\n      }, 80);\n    } catch (e) {\n      console.error(\"‚ùå loadMessages\", e);\n    }\n  };\n\n  // -----------------------------------------------\n  // OPEN ROOM\n  // -----------------------------------------------\n  const openRoom = async room => {\n    if (!(room !== null && room !== void 0 && room._id)) return;\n    if (joinedRoomIdRef.current) {\n      socket.emit(\"leave_room\", {\n        roomId: joinedRoomIdRef.current\n      });\n    }\n    socket.emit(\"join_room\", {\n      roomId: room._id\n    });\n    joinedRoomIdRef.current = room._id;\n    setCurrentRoom(room);\n    loadMessages(room);\n  };\n\n  // -----------------------------------------------\n  // RECEIVE MESSAGE ‚Äî cleanup CHU·∫®N 100%\n  // -----------------------------------------------\n  useEffect(() => {\n    const handler = payload => {\n      if (!currentRoom) return;\n      if (String(payload.roomId) !== String(currentRoom._id)) return;\n      if (String(payload.fromUserId) === String(myId)) return;\n      setMessages(prev => [...prev, normalizeMsg(payload)]);\n      setTimeout(() => {\n        var _bottomRef$current2;\n        return (_bottomRef$current2 = bottomRef.current) === null || _bottomRef$current2 === void 0 ? void 0 : _bottomRef$current2.scrollIntoView();\n      }, 80);\n    };\n    socket.on(\"receive_message\", handler);\n\n    // cleanup CHU·∫®N\n    return () => {\n      socket.off(\"receive_message\", handler);\n    };\n  }, [currentRoom, myId]);\n\n  // -----------------------------------------------\n  // SEND MESSAGE\n  // -----------------------------------------------\n  const sendMessage = async e => {\n    e.preventDefault();\n    if (!text.trim() || !currentRoom) return;\n    const content = text.trim();\n    try {\n      var _bottomRef$current3;\n      const saved = await api.post(\"/messages\", {\n        roomId: currentRoom._id,\n        content\n      });\n      const msg = normalizeMsg(saved.data);\n      msg.sender = {\n        _id: myId,\n        username: me.username\n      };\n      socket.emit(\"send_message\", {\n        roomId: currentRoom._id,\n        content,\n        fromUserId: myId,\n        fromUserName: me.username\n      });\n      setMessages(prev => [...prev, msg]);\n      setText(\"\");\n      (_bottomRef$current3 = bottomRef.current) === null || _bottomRef$current3 === void 0 ? void 0 : _bottomRef$current3.scrollIntoView();\n    } catch (e) {\n      console.error(\"‚ùå sendMessage\", e);\n    }\n  };\n\n  // -----------------------------------------------\n  // START PRIVATE CHAT\n  // -----------------------------------------------\n  const startPrivateWith = async otherUserId => {\n    try {\n      const res = await api.post(\"/messages/rooms/private\", {\n        otherUserId\n      });\n      await loadRooms();\n      openRoom(res.data);\n    } catch (e) {\n      console.error(\"‚ùå startPrivate\", e);\n    }\n  };\n  const privateTitle = room => {\n    const participants = (room.participants || []).map(p => ({\n      id: extractId(p),\n      username: p.username\n    }));\n    const others = participants.filter(p => p.id !== myId);\n    if (others.length === 0) return \"Kh√¥ng x√°c ƒë·ªãnh\";\n    return others.map(p => p.username).join(\", \");\n  };\n  if (!me) return /*#__PURE__*/_jsxDEV(UserLayout, {\n    children: /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"text-center mt-4\",\n      children: \"\\u0110ang t\\u1EA3i...\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 233,\n      columnNumber: 9\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 232,\n    columnNumber: 7\n  }, this);\n  return /*#__PURE__*/_jsxDEV(UserLayout, {\n    role: me.role,\n    children: [/*#__PURE__*/_jsxDEV(\"h2\", {\n      className: \"mb-3\",\n      children: \"\\uD83D\\uDCAC Chat\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 239,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"d-flex gap-3\",\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        style: {\n          width: 300\n        },\n        children: /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"card p-2\",\n          children: [/*#__PURE__*/_jsxDEV(\"h5\", {\n            children: \"Ph\\xF2ng chat\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 245,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"form-check form-switch my-2\",\n            children: [/*#__PURE__*/_jsxDEV(\"input\", {\n              className: \"form-check-input\",\n              type: \"checkbox\",\n              checked: chatOutsideDept,\n              onChange: () => setChatOutsideDept(!chatOutsideDept)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 248,\n              columnNumber: 15\n            }, this), /*#__PURE__*/_jsxDEV(\"label\", {\n              children: \"Chat ngo\\xE0i ph\\xF2ng ban\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 254,\n              columnNumber: 15\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 247,\n            columnNumber: 13\n          }, this), deptRoom && /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"mb-2\",\n            children: [/*#__PURE__*/_jsxDEV(\"strong\", {\n              children: [\"\\uD83D\\uDC65 \", deptRoom.name]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 259,\n              columnNumber: 17\n            }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n              className: \"btn btn-sm btn-outline-primary float-end\",\n              onClick: () => openRoom(deptRoom),\n              children: \"M\\u1EDF\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 260,\n              columnNumber: 17\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 258,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"hr\", {}, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 269,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(\"small\", {\n            className: \"text-muted\",\n            children: [\"Nh\\xE2n vi\\xEAn \", chatOutsideDept ? \"to√†n c√¥ng ty\" : \"ph√≤ng ban\"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 270,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"list-group mt-1\",\n            style: {\n              maxHeight: 250,\n              overflowY: \"auto\"\n            },\n            children: employees.map(e => /*#__PURE__*/_jsxDEV(\"button\", {\n              className: \"list-group-item list-group-item-action\",\n              onClick: () => startPrivateWith(e.userId),\n              children: [e.name, \" (\", e.username, \")\"]\n            }, e._id, true, {\n              fileName: _jsxFileName,\n              lineNumber: 279,\n              columnNumber: 17\n            }, this))\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 274,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(\"hr\", {}, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 289,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(\"small\", {\n            className: \"text-muted\",\n            children: \"\\u0110o\\u1EA1n chat g\\u1EA7n \\u0111\\xE2y\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 290,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"list-group mt-1\",\n            style: {\n              maxHeight: 200,\n              overflowY: \"auto\"\n            },\n            children: privateRooms.map(r => /*#__PURE__*/_jsxDEV(\"button\", {\n              className: \"list-group-item list-group-item-action\",\n              onClick: () => openRoom(r),\n              children: r.type === \"group\" ? \"üë• \" + r.name : privateTitle(r)\n            }, r._id, false, {\n              fileName: _jsxFileName,\n              lineNumber: 296,\n              columnNumber: 17\n            }, this))\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 291,\n            columnNumber: 13\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 244,\n          columnNumber: 11\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 243,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex-grow-1\",\n        children: /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"card\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"card-header d-flex justify-content-between\",\n            children: [/*#__PURE__*/_jsxDEV(\"strong\", {\n              children: currentRoom ? currentRoom.type === \"group\" ? `üë• ${currentRoom.name}` : `üí¨ ${privateTitle(currentRoom)}` : \"Ch·ªçn ƒëo·∫°n chat\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 312,\n              columnNumber: 15\n            }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n              className: \"btn btn-sm btn-outline-secondary\",\n              disabled: !currentRoom,\n              onClick: () => currentRoom && loadMessages(currentRoom),\n              children: \"\\u27F3\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 320,\n              columnNumber: 15\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 311,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"card-body\",\n            style: {\n              height: 520,\n              overflowY: \"auto\"\n            },\n            children: [messages.map(m => /*#__PURE__*/_jsxDEV(\"div\", {\n              className: `d-flex mb-2 ${isMine(m) ? \"justify-content-end\" : \"justify-content-start\"}`,\n              children: /*#__PURE__*/_jsxDEV(\"div\", {\n                className: `p-2 px-3 rounded-4 shadow-sm ${isMine(m) ? \"bg-primary text-white\" : \"bg-light text-dark\"}`,\n                style: {\n                  maxWidth: \"70%\"\n                },\n                children: [!isMine(m) && /*#__PURE__*/_jsxDEV(\"div\", {\n                  className: \"small text-muted mb-1\",\n                  children: m.sender.username\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 347,\n                  columnNumber: 23\n                }, this), m.content, /*#__PURE__*/_jsxDEV(\"div\", {\n                  className: \"small text-muted mt-1\",\n                  style: {\n                    fontSize: \"0.75rem\"\n                  },\n                  children: new Date(m.createdAt).toLocaleTimeString([], {\n                    hour: \"2-digit\",\n                    minute: \"2-digit\"\n                  })\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 354,\n                  columnNumber: 21\n                }, this)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 340,\n                columnNumber: 19\n              }, this)\n            }, m._id, false, {\n              fileName: _jsxFileName,\n              lineNumber: 334,\n              columnNumber: 17\n            }, this)), /*#__PURE__*/_jsxDEV(\"div\", {\n              ref: bottomRef\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 367,\n              columnNumber: 15\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 329,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"card-footer\",\n            children: /*#__PURE__*/_jsxDEV(\"form\", {\n              className: \"d-flex gap-2\",\n              onSubmit: sendMessage,\n              children: [/*#__PURE__*/_jsxDEV(\"input\", {\n                className: \"form-control\",\n                value: text,\n                placeholder: \"Nh\\u1EADp tin nh\\u1EAFn...\",\n                onChange: e => setText(e.target.value),\n                disabled: !currentRoom\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 372,\n                columnNumber: 17\n              }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n                className: \"btn btn-primary\",\n                disabled: !text.trim(),\n                children: \"G\\u1EEDi\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 379,\n                columnNumber: 17\n              }, this)]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 371,\n              columnNumber: 15\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 370,\n            columnNumber: 13\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 310,\n          columnNumber: 11\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 309,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 241,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 238,\n    columnNumber: 5\n  }, this);\n}\n_s(Chat, \"ulE/MCdbdqL1a2QJEx7i+irniZk=\", false, function () {\n  return [useAuth];\n});\n_c = Chat;\nvar _c;\n$RefreshReg$(_c, \"Chat\");","map":{"version":3,"names":["React","useEffect","useRef","useState","io","api","UserLayout","useAuth","jsxDEV","_jsxDEV","SOCKET_BASE","process","env","REACT_APP_API_BASE","replace","socket","transports","autoConnect","Chat","_s","user","me","deptRoom","setDeptRoom","privateRooms","setPrivateRooms","employees","setEmployees","chatOutsideDept","setChatOutsideDept","currentRoom","setCurrentRoom","messages","setMessages","text","setText","bottomRef","joinedRoomIdRef","myId","_id","myDept","department","extractId","val","_ref","_val$_id","id","isMine","m","String","sender","normalizeMsg","raw","_raw$sender","Math","random","toString","slice","roomId","username","fromUsername","fromUserName","content","message","createdAt","Date","toISOString","emit","userId","current","off","loadRooms","res","get","data","e","console","error","loadEmployees","scope","map","_e$userId","_e$userId2","name","loadMessages","room","setTimeout","_bottomRef$current","scrollIntoView","openRoom","handler","payload","fromUserId","prev","_bottomRef$current2","on","sendMessage","preventDefault","trim","_bottomRef$current3","saved","post","msg","startPrivateWith","otherUserId","privateTitle","participants","p","others","filter","length","join","children","className","fileName","_jsxFileName","lineNumber","columnNumber","role","style","width","type","checked","onChange","onClick","maxHeight","overflowY","r","disabled","height","maxWidth","fontSize","toLocaleTimeString","hour","minute","ref","onSubmit","value","placeholder","target","_c","$RefreshReg$"],"sources":["C:/HRM_Project/frontend/src/pages/user/Chat.js"],"sourcesContent":["import React, { useEffect, useRef, useState } from \"react\";\r\nimport io from \"socket.io-client\";\r\nimport api from \"../../api\";\r\nimport UserLayout from \"../../layouts/UserLayout\";\r\nimport { useAuth } from \"../../context/AuthContext\";\r\n\r\n// Socket URL\r\nconst SOCKET_BASE =\r\n  (process.env.REACT_APP_API_BASE || \"http://localhost:5000\").replace(\"/api\", \"\");\r\n\r\nconst socket = io(SOCKET_BASE, {\r\n  transports: [\"websocket\"],\r\n  autoConnect: true,\r\n});\r\n\r\nexport default function Chat() {\r\n  const { user } = useAuth();\r\n  const me = user;\r\n\r\n  const [deptRoom, setDeptRoom] = useState(null);\r\n  const [privateRooms, setPrivateRooms] = useState([]);\r\n  const [employees, setEmployees] = useState([]);\r\n  const [chatOutsideDept, setChatOutsideDept] = useState(false);\r\n\r\n  const [currentRoom, setCurrentRoom] = useState(null);\r\n  const [messages, setMessages] = useState([]);\r\n  const [text, setText] = useState(\"\");\r\n\r\n  const bottomRef = useRef(null);\r\n  const joinedRoomIdRef = useRef(null);\r\n\r\n  const myId = me?._id;\r\n  const myDept = me?.department || null;\r\n\r\n  const extractId = (val) => {\r\n    if (!val) return \"\";\r\n    if (typeof val === \"string\") return val;\r\n    return val._id ?? val.id ?? \"\";\r\n  };\r\n\r\n  const isMine = (m) => String(extractId(m.sender)) === String(myId);\r\n\r\n  const normalizeMsg = (raw) => ({\r\n    _id: String(raw?._id || Math.random().toString(36).slice(2)),\r\n    roomId: String(raw?.roomId || currentRoom?._id || \"\"),\r\n    sender: {\r\n      _id: extractId(raw?.sender),\r\n      username:\r\n        raw?.sender?.username ||\r\n        raw?.fromUsername ||\r\n        raw?.fromUserName ||\r\n        \"N/A\",\r\n    },\r\n    content: raw?.content || raw?.message || \"\",\r\n    createdAt: raw?.createdAt || new Date().toISOString(),\r\n  });\r\n\r\n  // -----------------------------------------------\r\n  // 1) JOIN SOCKET + CLEANUP CHU·∫®N (fix destroy error)\r\n  // -----------------------------------------------\r\n  useEffect(() => {\r\n    if (myId) {\r\n      socket.emit(\"join\", { userId: myId, department: myDept });\r\n    }\r\n\r\n    return () => {\r\n      if (joinedRoomIdRef.current) {\r\n        socket.emit(\"leave_room\", { roomId: joinedRoomIdRef.current });\r\n      }\r\n\r\n      // cleanup t·∫•t c·∫£ listener tr√°nh leak\r\n      socket.off(\"receive_message\");\r\n      socket.off(\"join_room\");\r\n      socket.off(\"leave_room\");\r\n    };\r\n  }, [myId, myDept]);\r\n\r\n  // -----------------------------------------------\r\n  // LOAD ROOMS\r\n  // -----------------------------------------------\r\n  const loadRooms = async () => {\r\n    try {\r\n      const res = await api.get(\"/messages/rooms\");\r\n      setPrivateRooms(res.data.privateRooms || []);\r\n      setDeptRoom(res.data.deptRoom || null);\r\n    } catch (e) {\r\n      console.error(\"‚ùå loadRooms\", e);\r\n    }\r\n  };\r\n\r\n  // -----------------------------------------------\r\n  // LOAD EMPLOYEES (fix normalize)\r\n  // -----------------------------------------------\r\n  const loadEmployees = async () => {\r\n    try {\r\n      const scope = chatOutsideDept ? \"all\" : \"dept\";\r\n      const res = await api.get(`/employees/peers?scope=${scope}`);\r\n\r\n      setEmployees(\r\n        (res.data || []).map((e) => ({\r\n          _id: e._id,\r\n          name: e.name,\r\n          userId: e.userId?._id,\r\n          username: e.userId?.username,\r\n          department: e.department,\r\n        }))\r\n      );\r\n    } catch (e) {\r\n      console.error(\"‚ùå loadEmployees\", e);\r\n      setEmployees([]);\r\n    }\r\n  };\r\n\r\n  useEffect(() => loadRooms(), []);\r\n  useEffect(() => loadEmployees(), [chatOutsideDept]);\r\n\r\n  // -----------------------------------------------\r\n  // LOAD MESSAGES BY ROOM\r\n  // -----------------------------------------------\r\n  const loadMessages = async (room) => {\r\n    try {\r\n      const res = await api.get(`/messages/${room._id}`);\r\n      setMessages(res.data.map(normalizeMsg));\r\n\r\n      setTimeout(() => bottomRef.current?.scrollIntoView(), 80);\r\n    } catch (e) {\r\n      console.error(\"‚ùå loadMessages\", e);\r\n    }\r\n  };\r\n\r\n  // -----------------------------------------------\r\n  // OPEN ROOM\r\n  // -----------------------------------------------\r\n  const openRoom = async (room) => {\r\n    if (!room?._id) return;\r\n\r\n    if (joinedRoomIdRef.current) {\r\n      socket.emit(\"leave_room\", { roomId: joinedRoomIdRef.current });\r\n    }\r\n\r\n    socket.emit(\"join_room\", { roomId: room._id });\r\n    joinedRoomIdRef.current = room._id;\r\n\r\n    setCurrentRoom(room);\r\n    loadMessages(room);\r\n  };\r\n\r\n  // -----------------------------------------------\r\n  // RECEIVE MESSAGE ‚Äî cleanup CHU·∫®N 100%\r\n  // -----------------------------------------------\r\n  useEffect(() => {\r\n    const handler = (payload) => {\r\n      if (!currentRoom) return;\r\n      if (String(payload.roomId) !== String(currentRoom._id)) return;\r\n      if (String(payload.fromUserId) === String(myId)) return;\r\n\r\n      setMessages((prev) => [...prev, normalizeMsg(payload)]);\r\n      setTimeout(() => bottomRef.current?.scrollIntoView(), 80);\r\n    };\r\n\r\n    socket.on(\"receive_message\", handler);\r\n\r\n    // cleanup CHU·∫®N\r\n    return () => {\r\n      socket.off(\"receive_message\", handler);\r\n    };\r\n  }, [currentRoom, myId]);\r\n\r\n  // -----------------------------------------------\r\n  // SEND MESSAGE\r\n  // -----------------------------------------------\r\n  const sendMessage = async (e) => {\r\n    e.preventDefault();\r\n    if (!text.trim() || !currentRoom) return;\r\n\r\n    const content = text.trim();\r\n\r\n    try {\r\n      const saved = await api.post(\"/messages\", {\r\n        roomId: currentRoom._id,\r\n        content,\r\n      });\r\n\r\n      const msg = normalizeMsg(saved.data);\r\n      msg.sender = { _id: myId, username: me.username };\r\n\r\n      socket.emit(\"send_message\", {\r\n        roomId: currentRoom._id,\r\n        content,\r\n        fromUserId: myId,\r\n        fromUserName: me.username,\r\n      });\r\n\r\n      setMessages((prev) => [...prev, msg]);\r\n      setText(\"\");\r\n      bottomRef.current?.scrollIntoView();\r\n    } catch (e) {\r\n      console.error(\"‚ùå sendMessage\", e);\r\n    }\r\n  };\r\n\r\n  // -----------------------------------------------\r\n  // START PRIVATE CHAT\r\n  // -----------------------------------------------\r\n  const startPrivateWith = async (otherUserId) => {\r\n    try {\r\n      const res = await api.post(\"/messages/rooms/private\", {\r\n        otherUserId,\r\n      });\r\n\r\n      await loadRooms();\r\n      openRoom(res.data);\r\n    } catch (e) {\r\n      console.error(\"‚ùå startPrivate\", e);\r\n    }\r\n  };\r\n\r\n  const privateTitle = (room) => {\r\n    const participants = (room.participants || []).map((p) => ({\r\n      id: extractId(p),\r\n      username: p.username,\r\n    }));\r\n\r\n    const others = participants.filter((p) => p.id !== myId);\r\n\r\n    if (others.length === 0) return \"Kh√¥ng x√°c ƒë·ªãnh\";\r\n    return others.map((p) => p.username).join(\", \");\r\n  };\r\n\r\n  if (!me)\r\n    return (\r\n      <UserLayout>\r\n        <div className=\"text-center mt-4\">ƒêang t·∫£i...</div>\r\n      </UserLayout>\r\n    );\r\n\r\n  return (\r\n    <UserLayout role={me.role}>\r\n      <h2 className=\"mb-3\">üí¨ Chat</h2>\r\n\r\n      <div className=\"d-flex gap-3\">\r\n        {/* LEFT PANEL */}\r\n        <div style={{ width: 300 }}>\r\n          <div className=\"card p-2\">\r\n            <h5>Ph√≤ng chat</h5>\r\n\r\n            <div className=\"form-check form-switch my-2\">\r\n              <input\r\n                className=\"form-check-input\"\r\n                type=\"checkbox\"\r\n                checked={chatOutsideDept}\r\n                onChange={() => setChatOutsideDept(!chatOutsideDept)}\r\n              />\r\n              <label>Chat ngo√†i ph√≤ng ban</label>\r\n            </div>\r\n\r\n            {deptRoom && (\r\n              <div className=\"mb-2\">\r\n                <strong>üë• {deptRoom.name}</strong>\r\n                <button\r\n                  className=\"btn btn-sm btn-outline-primary float-end\"\r\n                  onClick={() => openRoom(deptRoom)}\r\n                >\r\n                  M·ªü\r\n                </button>\r\n              </div>\r\n            )}\r\n\r\n            <hr />\r\n            <small className=\"text-muted\">\r\n              Nh√¢n vi√™n {chatOutsideDept ? \"to√†n c√¥ng ty\" : \"ph√≤ng ban\"}\r\n            </small>\r\n\r\n            <div\r\n              className=\"list-group mt-1\"\r\n              style={{ maxHeight: 250, overflowY: \"auto\" }}\r\n            >\r\n              {employees.map((e) => (\r\n                <button\r\n                  key={e._id}\r\n                  className=\"list-group-item list-group-item-action\"\r\n                  onClick={() => startPrivateWith(e.userId)}\r\n                >\r\n                  {e.name} ({e.username})\r\n                </button>\r\n              ))}\r\n            </div>\r\n\r\n            <hr />\r\n            <small className=\"text-muted\">ƒêo·∫°n chat g·∫ßn ƒë√¢y</small>\r\n            <div\r\n              className=\"list-group mt-1\"\r\n              style={{ maxHeight: 200, overflowY: \"auto\" }}\r\n            >\r\n              {privateRooms.map((r) => (\r\n                <button\r\n                  key={r._id}\r\n                  className=\"list-group-item list-group-item-action\"\r\n                  onClick={() => openRoom(r)}\r\n                >\r\n                  {r.type === \"group\" ? \"üë• \" + r.name : privateTitle(r)}\r\n                </button>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* CHAT BOX */}\r\n        <div className=\"flex-grow-1\">\r\n          <div className=\"card\">\r\n            <div className=\"card-header d-flex justify-content-between\">\r\n              <strong>\r\n                {currentRoom\r\n                  ? currentRoom.type === \"group\"\r\n                    ? `üë• ${currentRoom.name}`\r\n                    : `üí¨ ${privateTitle(currentRoom)}`\r\n                  : \"Ch·ªçn ƒëo·∫°n chat\"}\r\n              </strong>\r\n\r\n              <button\r\n                className=\"btn btn-sm btn-outline-secondary\"\r\n                disabled={!currentRoom}\r\n                onClick={() => currentRoom && loadMessages(currentRoom)}\r\n              >\r\n                ‚ü≥\r\n              </button>\r\n            </div>\r\n\r\n            <div\r\n              className=\"card-body\"\r\n              style={{ height: 520, overflowY: \"auto\" }}\r\n            >\r\n              {messages.map((m) => (\r\n                <div\r\n                  key={m._id}\r\n                  className={`d-flex mb-2 ${\r\n                    isMine(m) ? \"justify-content-end\" : \"justify-content-start\"\r\n                  }`}\r\n                >\r\n                  <div\r\n                    className={`p-2 px-3 rounded-4 shadow-sm ${\r\n                      isMine(m) ? \"bg-primary text-white\" : \"bg-light text-dark\"\r\n                    }`}\r\n                    style={{ maxWidth: \"70%\" }}\r\n                  >\r\n                    {!isMine(m) && (\r\n                      <div className=\"small text-muted mb-1\">\r\n                        {m.sender.username}\r\n                      </div>\r\n                    )}\r\n\r\n                    {m.content}\r\n\r\n                    <div\r\n                      className=\"small text-muted mt-1\"\r\n                      style={{ fontSize: \"0.75rem\" }}\r\n                    >\r\n                      {new Date(m.createdAt).toLocaleTimeString([], {\r\n                        hour: \"2-digit\",\r\n                        minute: \"2-digit\",\r\n                      })}\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              ))}\r\n\r\n              <div ref={bottomRef}></div>\r\n            </div>\r\n\r\n            <div className=\"card-footer\">\r\n              <form className=\"d-flex gap-2\" onSubmit={sendMessage}>\r\n                <input\r\n                  className=\"form-control\"\r\n                  value={text}\r\n                  placeholder=\"Nh·∫≠p tin nh·∫Øn...\"\r\n                  onChange={(e) => setText(e.target.value)}\r\n                  disabled={!currentRoom}\r\n                />\r\n                <button className=\"btn btn-primary\" disabled={!text.trim()}>\r\n                  G·ª≠i\r\n                </button>\r\n              </form>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </UserLayout>\r\n  );\r\n}\r\n"],"mappings":";;AAAA,OAAOA,KAAK,IAAIC,SAAS,EAAEC,MAAM,EAAEC,QAAQ,QAAQ,OAAO;AAC1D,OAAOC,EAAE,MAAM,kBAAkB;AACjC,OAAOC,GAAG,MAAM,WAAW;AAC3B,OAAOC,UAAU,MAAM,0BAA0B;AACjD,SAASC,OAAO,QAAQ,2BAA2B;;AAEnD;AAAA,SAAAC,MAAA,IAAAC,OAAA;AACA,MAAMC,WAAW,GACf,CAACC,OAAO,CAACC,GAAG,CAACC,kBAAkB,IAAI,uBAAuB,EAAEC,OAAO,CAAC,MAAM,EAAE,EAAE,CAAC;AAEjF,MAAMC,MAAM,GAAGX,EAAE,CAACM,WAAW,EAAE;EAC7BM,UAAU,EAAE,CAAC,WAAW,CAAC;EACzBC,WAAW,EAAE;AACf,CAAC,CAAC;AAEF,eAAe,SAASC,IAAIA,CAAA,EAAG;EAAAC,EAAA;EAC7B,MAAM;IAAEC;EAAK,CAAC,GAAGb,OAAO,CAAC,CAAC;EAC1B,MAAMc,EAAE,GAAGD,IAAI;EAEf,MAAM,CAACE,QAAQ,EAAEC,WAAW,CAAC,GAAGpB,QAAQ,CAAC,IAAI,CAAC;EAC9C,MAAM,CAACqB,YAAY,EAAEC,eAAe,CAAC,GAAGtB,QAAQ,CAAC,EAAE,CAAC;EACpD,MAAM,CAACuB,SAAS,EAAEC,YAAY,CAAC,GAAGxB,QAAQ,CAAC,EAAE,CAAC;EAC9C,MAAM,CAACyB,eAAe,EAAEC,kBAAkB,CAAC,GAAG1B,QAAQ,CAAC,KAAK,CAAC;EAE7D,MAAM,CAAC2B,WAAW,EAAEC,cAAc,CAAC,GAAG5B,QAAQ,CAAC,IAAI,CAAC;EACpD,MAAM,CAAC6B,QAAQ,EAAEC,WAAW,CAAC,GAAG9B,QAAQ,CAAC,EAAE,CAAC;EAC5C,MAAM,CAAC+B,IAAI,EAAEC,OAAO,CAAC,GAAGhC,QAAQ,CAAC,EAAE,CAAC;EAEpC,MAAMiC,SAAS,GAAGlC,MAAM,CAAC,IAAI,CAAC;EAC9B,MAAMmC,eAAe,GAAGnC,MAAM,CAAC,IAAI,CAAC;EAEpC,MAAMoC,IAAI,GAAGjB,EAAE,aAAFA,EAAE,uBAAFA,EAAE,CAAEkB,GAAG;EACpB,MAAMC,MAAM,GAAG,CAAAnB,EAAE,aAAFA,EAAE,uBAAFA,EAAE,CAAEoB,UAAU,KAAI,IAAI;EAErC,MAAMC,SAAS,GAAIC,GAAG,IAAK;IAAA,IAAAC,IAAA,EAAAC,QAAA;IACzB,IAAI,CAACF,GAAG,EAAE,OAAO,EAAE;IACnB,IAAI,OAAOA,GAAG,KAAK,QAAQ,EAAE,OAAOA,GAAG;IACvC,QAAAC,IAAA,IAAAC,QAAA,GAAOF,GAAG,CAACJ,GAAG,cAAAM,QAAA,cAAAA,QAAA,GAAIF,GAAG,CAACG,EAAE,cAAAF,IAAA,cAAAA,IAAA,GAAI,EAAE;EAChC,CAAC;EAED,MAAMG,MAAM,GAAIC,CAAC,IAAKC,MAAM,CAACP,SAAS,CAACM,CAAC,CAACE,MAAM,CAAC,CAAC,KAAKD,MAAM,CAACX,IAAI,CAAC;EAElE,MAAMa,YAAY,GAAIC,GAAG;IAAA,IAAAC,WAAA;IAAA,OAAM;MAC7Bd,GAAG,EAAEU,MAAM,CAAC,CAAAG,GAAG,aAAHA,GAAG,uBAAHA,GAAG,CAAEb,GAAG,KAAIe,IAAI,CAACC,MAAM,CAAC,CAAC,CAACC,QAAQ,CAAC,EAAE,CAAC,CAACC,KAAK,CAAC,CAAC,CAAC,CAAC;MAC5DC,MAAM,EAAET,MAAM,CAAC,CAAAG,GAAG,aAAHA,GAAG,uBAAHA,GAAG,CAAEM,MAAM,MAAI5B,WAAW,aAAXA,WAAW,uBAAXA,WAAW,CAAES,GAAG,KAAI,EAAE,CAAC;MACrDW,MAAM,EAAE;QACNX,GAAG,EAAEG,SAAS,CAACU,GAAG,aAAHA,GAAG,uBAAHA,GAAG,CAAEF,MAAM,CAAC;QAC3BS,QAAQ,EACN,CAAAP,GAAG,aAAHA,GAAG,wBAAAC,WAAA,GAAHD,GAAG,CAAEF,MAAM,cAAAG,WAAA,uBAAXA,WAAA,CAAaM,QAAQ,MACrBP,GAAG,aAAHA,GAAG,uBAAHA,GAAG,CAAEQ,YAAY,MACjBR,GAAG,aAAHA,GAAG,uBAAHA,GAAG,CAAES,YAAY,KACjB;MACJ,CAAC;MACDC,OAAO,EAAE,CAAAV,GAAG,aAAHA,GAAG,uBAAHA,GAAG,CAAEU,OAAO,MAAIV,GAAG,aAAHA,GAAG,uBAAHA,GAAG,CAAEW,OAAO,KAAI,EAAE;MAC3CC,SAAS,EAAE,CAAAZ,GAAG,aAAHA,GAAG,uBAAHA,GAAG,CAAEY,SAAS,KAAI,IAAIC,IAAI,CAAC,CAAC,CAACC,WAAW,CAAC;IACtD,CAAC;EAAA,CAAC;;EAEF;EACA;EACA;EACAjE,SAAS,CAAC,MAAM;IACd,IAAIqC,IAAI,EAAE;MACRvB,MAAM,CAACoD,IAAI,CAAC,MAAM,EAAE;QAAEC,MAAM,EAAE9B,IAAI;QAAEG,UAAU,EAAED;MAAO,CAAC,CAAC;IAC3D;IAEA,OAAO,MAAM;MACX,IAAIH,eAAe,CAACgC,OAAO,EAAE;QAC3BtD,MAAM,CAACoD,IAAI,CAAC,YAAY,EAAE;UAAET,MAAM,EAAErB,eAAe,CAACgC;QAAQ,CAAC,CAAC;MAChE;;MAEA;MACAtD,MAAM,CAACuD,GAAG,CAAC,iBAAiB,CAAC;MAC7BvD,MAAM,CAACuD,GAAG,CAAC,WAAW,CAAC;MACvBvD,MAAM,CAACuD,GAAG,CAAC,YAAY,CAAC;IAC1B,CAAC;EACH,CAAC,EAAE,CAAChC,IAAI,EAAEE,MAAM,CAAC,CAAC;;EAElB;EACA;EACA;EACA,MAAM+B,SAAS,GAAG,MAAAA,CAAA,KAAY;IAC5B,IAAI;MACF,MAAMC,GAAG,GAAG,MAAMnE,GAAG,CAACoE,GAAG,CAAC,iBAAiB,CAAC;MAC5ChD,eAAe,CAAC+C,GAAG,CAACE,IAAI,CAAClD,YAAY,IAAI,EAAE,CAAC;MAC5CD,WAAW,CAACiD,GAAG,CAACE,IAAI,CAACpD,QAAQ,IAAI,IAAI,CAAC;IACxC,CAAC,CAAC,OAAOqD,CAAC,EAAE;MACVC,OAAO,CAACC,KAAK,CAAC,aAAa,EAAEF,CAAC,CAAC;IACjC;EACF,CAAC;;EAED;EACA;EACA;EACA,MAAMG,aAAa,GAAG,MAAAA,CAAA,KAAY;IAChC,IAAI;MACF,MAAMC,KAAK,GAAGnD,eAAe,GAAG,KAAK,GAAG,MAAM;MAC9C,MAAM4C,GAAG,GAAG,MAAMnE,GAAG,CAACoE,GAAG,CAAC,0BAA0BM,KAAK,EAAE,CAAC;MAE5DpD,YAAY,CACV,CAAC6C,GAAG,CAACE,IAAI,IAAI,EAAE,EAAEM,GAAG,CAAEL,CAAC;QAAA,IAAAM,SAAA,EAAAC,UAAA;QAAA,OAAM;UAC3B3C,GAAG,EAAEoC,CAAC,CAACpC,GAAG;UACV4C,IAAI,EAAER,CAAC,CAACQ,IAAI;UACZf,MAAM,GAAAa,SAAA,GAAEN,CAAC,CAACP,MAAM,cAAAa,SAAA,uBAARA,SAAA,CAAU1C,GAAG;UACrBoB,QAAQ,GAAAuB,UAAA,GAAEP,CAAC,CAACP,MAAM,cAAAc,UAAA,uBAARA,UAAA,CAAUvB,QAAQ;UAC5BlB,UAAU,EAAEkC,CAAC,CAAClC;QAChB,CAAC;MAAA,CAAC,CACJ,CAAC;IACH,CAAC,CAAC,OAAOkC,CAAC,EAAE;MACVC,OAAO,CAACC,KAAK,CAAC,iBAAiB,EAAEF,CAAC,CAAC;MACnChD,YAAY,CAAC,EAAE,CAAC;IAClB;EACF,CAAC;EAED1B,SAAS,CAAC,MAAMsE,SAAS,CAAC,CAAC,EAAE,EAAE,CAAC;EAChCtE,SAAS,CAAC,MAAM6E,aAAa,CAAC,CAAC,EAAE,CAAClD,eAAe,CAAC,CAAC;;EAEnD;EACA;EACA;EACA,MAAMwD,YAAY,GAAG,MAAOC,IAAI,IAAK;IACnC,IAAI;MACF,MAAMb,GAAG,GAAG,MAAMnE,GAAG,CAACoE,GAAG,CAAC,aAAaY,IAAI,CAAC9C,GAAG,EAAE,CAAC;MAClDN,WAAW,CAACuC,GAAG,CAACE,IAAI,CAACM,GAAG,CAAC7B,YAAY,CAAC,CAAC;MAEvCmC,UAAU,CAAC;QAAA,IAAAC,kBAAA;QAAA,QAAAA,kBAAA,GAAMnD,SAAS,CAACiC,OAAO,cAAAkB,kBAAA,uBAAjBA,kBAAA,CAAmBC,cAAc,CAAC,CAAC;MAAA,GAAE,EAAE,CAAC;IAC3D,CAAC,CAAC,OAAOb,CAAC,EAAE;MACVC,OAAO,CAACC,KAAK,CAAC,gBAAgB,EAAEF,CAAC,CAAC;IACpC;EACF,CAAC;;EAED;EACA;EACA;EACA,MAAMc,QAAQ,GAAG,MAAOJ,IAAI,IAAK;IAC/B,IAAI,EAACA,IAAI,aAAJA,IAAI,eAAJA,IAAI,CAAE9C,GAAG,GAAE;IAEhB,IAAIF,eAAe,CAACgC,OAAO,EAAE;MAC3BtD,MAAM,CAACoD,IAAI,CAAC,YAAY,EAAE;QAAET,MAAM,EAAErB,eAAe,CAACgC;MAAQ,CAAC,CAAC;IAChE;IAEAtD,MAAM,CAACoD,IAAI,CAAC,WAAW,EAAE;MAAET,MAAM,EAAE2B,IAAI,CAAC9C;IAAI,CAAC,CAAC;IAC9CF,eAAe,CAACgC,OAAO,GAAGgB,IAAI,CAAC9C,GAAG;IAElCR,cAAc,CAACsD,IAAI,CAAC;IACpBD,YAAY,CAACC,IAAI,CAAC;EACpB,CAAC;;EAED;EACA;EACA;EACApF,SAAS,CAAC,MAAM;IACd,MAAMyF,OAAO,GAAIC,OAAO,IAAK;MAC3B,IAAI,CAAC7D,WAAW,EAAE;MAClB,IAAImB,MAAM,CAAC0C,OAAO,CAACjC,MAAM,CAAC,KAAKT,MAAM,CAACnB,WAAW,CAACS,GAAG,CAAC,EAAE;MACxD,IAAIU,MAAM,CAAC0C,OAAO,CAACC,UAAU,CAAC,KAAK3C,MAAM,CAACX,IAAI,CAAC,EAAE;MAEjDL,WAAW,CAAE4D,IAAI,IAAK,CAAC,GAAGA,IAAI,EAAE1C,YAAY,CAACwC,OAAO,CAAC,CAAC,CAAC;MACvDL,UAAU,CAAC;QAAA,IAAAQ,mBAAA;QAAA,QAAAA,mBAAA,GAAM1D,SAAS,CAACiC,OAAO,cAAAyB,mBAAA,uBAAjBA,mBAAA,CAAmBN,cAAc,CAAC,CAAC;MAAA,GAAE,EAAE,CAAC;IAC3D,CAAC;IAEDzE,MAAM,CAACgF,EAAE,CAAC,iBAAiB,EAAEL,OAAO,CAAC;;IAErC;IACA,OAAO,MAAM;MACX3E,MAAM,CAACuD,GAAG,CAAC,iBAAiB,EAAEoB,OAAO,CAAC;IACxC,CAAC;EACH,CAAC,EAAE,CAAC5D,WAAW,EAAEQ,IAAI,CAAC,CAAC;;EAEvB;EACA;EACA;EACA,MAAM0D,WAAW,GAAG,MAAOrB,CAAC,IAAK;IAC/BA,CAAC,CAACsB,cAAc,CAAC,CAAC;IAClB,IAAI,CAAC/D,IAAI,CAACgE,IAAI,CAAC,CAAC,IAAI,CAACpE,WAAW,EAAE;IAElC,MAAMgC,OAAO,GAAG5B,IAAI,CAACgE,IAAI,CAAC,CAAC;IAE3B,IAAI;MAAA,IAAAC,mBAAA;MACF,MAAMC,KAAK,GAAG,MAAM/F,GAAG,CAACgG,IAAI,CAAC,WAAW,EAAE;QACxC3C,MAAM,EAAE5B,WAAW,CAACS,GAAG;QACvBuB;MACF,CAAC,CAAC;MAEF,MAAMwC,GAAG,GAAGnD,YAAY,CAACiD,KAAK,CAAC1B,IAAI,CAAC;MACpC4B,GAAG,CAACpD,MAAM,GAAG;QAAEX,GAAG,EAAED,IAAI;QAAEqB,QAAQ,EAAEtC,EAAE,CAACsC;MAAS,CAAC;MAEjD5C,MAAM,CAACoD,IAAI,CAAC,cAAc,EAAE;QAC1BT,MAAM,EAAE5B,WAAW,CAACS,GAAG;QACvBuB,OAAO;QACP8B,UAAU,EAAEtD,IAAI;QAChBuB,YAAY,EAAExC,EAAE,CAACsC;MACnB,CAAC,CAAC;MAEF1B,WAAW,CAAE4D,IAAI,IAAK,CAAC,GAAGA,IAAI,EAAES,GAAG,CAAC,CAAC;MACrCnE,OAAO,CAAC,EAAE,CAAC;MACX,CAAAgE,mBAAA,GAAA/D,SAAS,CAACiC,OAAO,cAAA8B,mBAAA,uBAAjBA,mBAAA,CAAmBX,cAAc,CAAC,CAAC;IACrC,CAAC,CAAC,OAAOb,CAAC,EAAE;MACVC,OAAO,CAACC,KAAK,CAAC,eAAe,EAAEF,CAAC,CAAC;IACnC;EACF,CAAC;;EAED;EACA;EACA;EACA,MAAM4B,gBAAgB,GAAG,MAAOC,WAAW,IAAK;IAC9C,IAAI;MACF,MAAMhC,GAAG,GAAG,MAAMnE,GAAG,CAACgG,IAAI,CAAC,yBAAyB,EAAE;QACpDG;MACF,CAAC,CAAC;MAEF,MAAMjC,SAAS,CAAC,CAAC;MACjBkB,QAAQ,CAACjB,GAAG,CAACE,IAAI,CAAC;IACpB,CAAC,CAAC,OAAOC,CAAC,EAAE;MACVC,OAAO,CAACC,KAAK,CAAC,gBAAgB,EAAEF,CAAC,CAAC;IACpC;EACF,CAAC;EAED,MAAM8B,YAAY,GAAIpB,IAAI,IAAK;IAC7B,MAAMqB,YAAY,GAAG,CAACrB,IAAI,CAACqB,YAAY,IAAI,EAAE,EAAE1B,GAAG,CAAE2B,CAAC,KAAM;MACzD7D,EAAE,EAAEJ,SAAS,CAACiE,CAAC,CAAC;MAChBhD,QAAQ,EAAEgD,CAAC,CAAChD;IACd,CAAC,CAAC,CAAC;IAEH,MAAMiD,MAAM,GAAGF,YAAY,CAACG,MAAM,CAAEF,CAAC,IAAKA,CAAC,CAAC7D,EAAE,KAAKR,IAAI,CAAC;IAExD,IAAIsE,MAAM,CAACE,MAAM,KAAK,CAAC,EAAE,OAAO,gBAAgB;IAChD,OAAOF,MAAM,CAAC5B,GAAG,CAAE2B,CAAC,IAAKA,CAAC,CAAChD,QAAQ,CAAC,CAACoD,IAAI,CAAC,IAAI,CAAC;EACjD,CAAC;EAED,IAAI,CAAC1F,EAAE,EACL,oBACEZ,OAAA,CAACH,UAAU;IAAA0G,QAAA,eACTvG,OAAA;MAAKwG,SAAS,EAAC,kBAAkB;MAAAD,QAAA,EAAC;IAAW;MAAAE,QAAA,EAAAC,YAAA;MAAAC,UAAA;MAAAC,YAAA;IAAA,OAAK;EAAC;IAAAH,QAAA,EAAAC,YAAA;IAAAC,UAAA;IAAAC,YAAA;EAAA,OACzC,CAAC;EAGjB,oBACE5G,OAAA,CAACH,UAAU;IAACgH,IAAI,EAAEjG,EAAE,CAACiG,IAAK;IAAAN,QAAA,gBACxBvG,OAAA;MAAIwG,SAAS,EAAC,MAAM;MAAAD,QAAA,EAAC;IAAO;MAAAE,QAAA,EAAAC,YAAA;MAAAC,UAAA;MAAAC,YAAA;IAAA,OAAI,CAAC,eAEjC5G,OAAA;MAAKwG,SAAS,EAAC,cAAc;MAAAD,QAAA,gBAE3BvG,OAAA;QAAK8G,KAAK,EAAE;UAAEC,KAAK,EAAE;QAAI,CAAE;QAAAR,QAAA,eACzBvG,OAAA;UAAKwG,SAAS,EAAC,UAAU;UAAAD,QAAA,gBACvBvG,OAAA;YAAAuG,QAAA,EAAI;UAAU;YAAAE,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAAI,CAAC,eAEnB5G,OAAA;YAAKwG,SAAS,EAAC,6BAA6B;YAAAD,QAAA,gBAC1CvG,OAAA;cACEwG,SAAS,EAAC,kBAAkB;cAC5BQ,IAAI,EAAC,UAAU;cACfC,OAAO,EAAE9F,eAAgB;cACzB+F,QAAQ,EAAEA,CAAA,KAAM9F,kBAAkB,CAAC,CAACD,eAAe;YAAE;cAAAsF,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OACtD,CAAC,eACF5G,OAAA;cAAAuG,QAAA,EAAO;YAAoB;cAAAE,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OAAO,CAAC;UAAA;YAAAH,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAChC,CAAC,EAEL/F,QAAQ,iBACPb,OAAA;YAAKwG,SAAS,EAAC,MAAM;YAAAD,QAAA,gBACnBvG,OAAA;cAAAuG,QAAA,GAAQ,eAAG,EAAC1F,QAAQ,CAAC6D,IAAI;YAAA;cAAA+B,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OAAS,CAAC,eACnC5G,OAAA;cACEwG,SAAS,EAAC,0CAA0C;cACpDW,OAAO,EAAEA,CAAA,KAAMnC,QAAQ,CAACnE,QAAQ,CAAE;cAAA0F,QAAA,EACnC;YAED;cAAAE,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OAAQ,CAAC;UAAA;YAAAH,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OACN,CACN,eAED5G,OAAA;YAAAyG,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAAK,CAAC,eACN5G,OAAA;YAAOwG,SAAS,EAAC,YAAY;YAAAD,QAAA,GAAC,kBAClB,EAACpF,eAAe,GAAG,cAAc,GAAG,WAAW;UAAA;YAAAsF,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OACpD,CAAC,eAER5G,OAAA;YACEwG,SAAS,EAAC,iBAAiB;YAC3BM,KAAK,EAAE;cAAEM,SAAS,EAAE,GAAG;cAAEC,SAAS,EAAE;YAAO,CAAE;YAAAd,QAAA,EAE5CtF,SAAS,CAACsD,GAAG,CAAEL,CAAC,iBACflE,OAAA;cAEEwG,SAAS,EAAC,wCAAwC;cAClDW,OAAO,EAAEA,CAAA,KAAMrB,gBAAgB,CAAC5B,CAAC,CAACP,MAAM,CAAE;cAAA4C,QAAA,GAEzCrC,CAAC,CAACQ,IAAI,EAAC,IAAE,EAACR,CAAC,CAAChB,QAAQ,EAAC,GACxB;YAAA,GALOgB,CAAC,CAACpC,GAAG;cAAA2E,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OAKJ,CACT;UAAC;YAAAH,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OACC,CAAC,eAEN5G,OAAA;YAAAyG,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAAK,CAAC,eACN5G,OAAA;YAAOwG,SAAS,EAAC,YAAY;YAAAD,QAAA,EAAC;UAAiB;YAAAE,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAAO,CAAC,eACvD5G,OAAA;YACEwG,SAAS,EAAC,iBAAiB;YAC3BM,KAAK,EAAE;cAAEM,SAAS,EAAE,GAAG;cAAEC,SAAS,EAAE;YAAO,CAAE;YAAAd,QAAA,EAE5CxF,YAAY,CAACwD,GAAG,CAAE+C,CAAC,iBAClBtH,OAAA;cAEEwG,SAAS,EAAC,wCAAwC;cAClDW,OAAO,EAAEA,CAAA,KAAMnC,QAAQ,CAACsC,CAAC,CAAE;cAAAf,QAAA,EAE1Be,CAAC,CAACN,IAAI,KAAK,OAAO,GAAG,KAAK,GAAGM,CAAC,CAAC5C,IAAI,GAAGsB,YAAY,CAACsB,CAAC;YAAC,GAJjDA,CAAC,CAACxF,GAAG;cAAA2E,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OAKJ,CACT;UAAC;YAAAH,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OACC,CAAC;QAAA;UAAAH,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OACH;MAAC;QAAAH,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OACH,CAAC,eAGN5G,OAAA;QAAKwG,SAAS,EAAC,aAAa;QAAAD,QAAA,eAC1BvG,OAAA;UAAKwG,SAAS,EAAC,MAAM;UAAAD,QAAA,gBACnBvG,OAAA;YAAKwG,SAAS,EAAC,4CAA4C;YAAAD,QAAA,gBACzDvG,OAAA;cAAAuG,QAAA,EACGlF,WAAW,GACRA,WAAW,CAAC2F,IAAI,KAAK,OAAO,GAC1B,MAAM3F,WAAW,CAACqD,IAAI,EAAE,GACxB,MAAMsB,YAAY,CAAC3E,WAAW,CAAC,EAAE,GACnC;YAAgB;cAAAoF,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OACd,CAAC,eAET5G,OAAA;cACEwG,SAAS,EAAC,kCAAkC;cAC5Ce,QAAQ,EAAE,CAAClG,WAAY;cACvB8F,OAAO,EAAEA,CAAA,KAAM9F,WAAW,IAAIsD,YAAY,CAACtD,WAAW,CAAE;cAAAkF,QAAA,EACzD;YAED;cAAAE,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OAAQ,CAAC;UAAA;YAAAH,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OACN,CAAC,eAEN5G,OAAA;YACEwG,SAAS,EAAC,WAAW;YACrBM,KAAK,EAAE;cAAEU,MAAM,EAAE,GAAG;cAAEH,SAAS,EAAE;YAAO,CAAE;YAAAd,QAAA,GAEzChF,QAAQ,CAACgD,GAAG,CAAEhC,CAAC,iBACdvC,OAAA;cAEEwG,SAAS,EAAE,eACTlE,MAAM,CAACC,CAAC,CAAC,GAAG,qBAAqB,GAAG,uBAAuB,EAC1D;cAAAgE,QAAA,eAEHvG,OAAA;gBACEwG,SAAS,EAAE,gCACTlE,MAAM,CAACC,CAAC,CAAC,GAAG,uBAAuB,GAAG,oBAAoB,EACzD;gBACHuE,KAAK,EAAE;kBAAEW,QAAQ,EAAE;gBAAM,CAAE;gBAAAlB,QAAA,GAE1B,CAACjE,MAAM,CAACC,CAAC,CAAC,iBACTvC,OAAA;kBAAKwG,SAAS,EAAC,uBAAuB;kBAAAD,QAAA,EACnChE,CAAC,CAACE,MAAM,CAACS;gBAAQ;kBAAAuD,QAAA,EAAAC,YAAA;kBAAAC,UAAA;kBAAAC,YAAA;gBAAA,OACf,CACN,EAEArE,CAAC,CAACc,OAAO,eAEVrD,OAAA;kBACEwG,SAAS,EAAC,uBAAuB;kBACjCM,KAAK,EAAE;oBAAEY,QAAQ,EAAE;kBAAU,CAAE;kBAAAnB,QAAA,EAE9B,IAAI/C,IAAI,CAACjB,CAAC,CAACgB,SAAS,CAAC,CAACoE,kBAAkB,CAAC,EAAE,EAAE;oBAC5CC,IAAI,EAAE,SAAS;oBACfC,MAAM,EAAE;kBACV,CAAC;gBAAC;kBAAApB,QAAA,EAAAC,YAAA;kBAAAC,UAAA;kBAAAC,YAAA;gBAAA,OACC,CAAC;cAAA;gBAAAH,QAAA,EAAAC,YAAA;gBAAAC,UAAA;gBAAAC,YAAA;cAAA,OACH;YAAC,GA5BDrE,CAAC,CAACT,GAAG;cAAA2E,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OA6BP,CACN,CAAC,eAEF5G,OAAA;cAAK8H,GAAG,EAAEnG;YAAU;cAAA8E,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OAAM,CAAC;UAAA;YAAAH,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OACxB,CAAC,eAEN5G,OAAA;YAAKwG,SAAS,EAAC,aAAa;YAAAD,QAAA,eAC1BvG,OAAA;cAAMwG,SAAS,EAAC,cAAc;cAACuB,QAAQ,EAAExC,WAAY;cAAAgB,QAAA,gBACnDvG,OAAA;gBACEwG,SAAS,EAAC,cAAc;gBACxBwB,KAAK,EAAEvG,IAAK;gBACZwG,WAAW,EAAC,4BAAkB;gBAC9Bf,QAAQ,EAAGhD,CAAC,IAAKxC,OAAO,CAACwC,CAAC,CAACgE,MAAM,CAACF,KAAK,CAAE;gBACzCT,QAAQ,EAAE,CAAClG;cAAY;gBAAAoF,QAAA,EAAAC,YAAA;gBAAAC,UAAA;gBAAAC,YAAA;cAAA,OACxB,CAAC,eACF5G,OAAA;gBAAQwG,SAAS,EAAC,iBAAiB;gBAACe,QAAQ,EAAE,CAAC9F,IAAI,CAACgE,IAAI,CAAC,CAAE;gBAAAc,QAAA,EAAC;cAE5D;gBAAAE,QAAA,EAAAC,YAAA;gBAAAC,UAAA;gBAAAC,YAAA;cAAA,OAAQ,CAAC;YAAA;cAAAH,QAAA,EAAAC,YAAA;cAAAC,UAAA;cAAAC,YAAA;YAAA,OACL;UAAC;YAAAH,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OACJ,CAAC;QAAA;UAAAH,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OACH;MAAC;QAAAH,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OACH,CAAC;IAAA;MAAAH,QAAA,EAAAC,YAAA;MAAAC,UAAA;MAAAC,YAAA;IAAA,OACH,CAAC;EAAA;IAAAH,QAAA,EAAAC,YAAA;IAAAC,UAAA;IAAAC,YAAA;EAAA,OACI,CAAC;AAEjB;AAAClG,EAAA,CArXuBD,IAAI;EAAA,QACTX,OAAO;AAAA;AAAAqI,EAAA,GADF1H,IAAI;AAAA,IAAA0H,EAAA;AAAAC,YAAA,CAAAD,EAAA","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}